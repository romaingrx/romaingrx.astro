---
import { getCollection, render, type CollectionEntry } from 'astro:content';

interface Props {
  type?: 'education' | 'experience' | 'project';
  title: string;
}

const { type, title } = Astro.props;

// Get timeline entries
const entries = await getCollection('timeline');
const filteredEntries = type
  ? entries.filter((entry: CollectionEntry<'timeline'>) => entry.data.type === type)
  : entries;

// Sort items by date (most recent first)
const sortedItems = [...filteredEntries].sort((a, b) => {
  const dateA = a.data.endDate === 'present' ? new Date() : new Date(a.data.startDate);
  const dateB = b.data.endDate === 'present' ? new Date() : new Date(b.data.startDate);
  return dateB.getTime() - dateA.getTime();
});

// Pre-render all content
const renderedContent = await Promise.all(
  sortedItems.map(async (item: CollectionEntry<'timeline'>) => {
    const rendered = await render(item);
    return {
      item,
      Content: rendered.Content,
    };
  })
);
---

<style>
  @keyframes pulse {
    0% {
      box-shadow: 0 0 0 0 rgb(16 185 129 / 0.7);
    }
    70% {
      box-shadow: 0 0 0 10px rgb(16 185 129 / 0);
    }
    100% {
      box-shadow: 0 0 0 0 rgb(16 185 129 / 0);
    }
  }
  .pulse {
    animation: pulse 2s infinite;
  }
</style>

<div class="flex flex-col">
  <h1
    class="font-wise mb-20 bg-gradient-to-r from-purple-400 to-purple-600 bg-clip-text text-center text-5xl font-bold text-transparent"
  >
    {title}
  </h1>

  <div class="relative">
    {/* Vertical Line */}
    <div
      class="absolute left-[29px] top-4 h-[calc(100%-2rem)] w-0.5 bg-gradient-to-b from-purple-400/50 to-purple-600/50 dark:from-purple-400/20 dark:to-purple-600/20"
    >
    </div>

    <div class="space-y-20">
      {
        renderedContent.map(({ item, Content }) => {
          const isActive = item.data.endDate === 'present';
          return (
            <div class="group relative ml-20" data-animate>
              {/* Timeline Dot */}
              <div class="absolute -left-[52px] top-0 flex items-center justify-center">
                <div
                  class:list={[
                    'relative h-[30px] w-[30px] rounded-full shadow-lg transition-all duration-300 group-hover:scale-110',
                    isActive
                      ? 'pulse bg-gradient-to-br from-emerald-100 to-emerald-200 dark:from-emerald-900/30 dark:to-emerald-800/30'
                      : 'bg-gradient-to-br from-purple-100 to-purple-200 dark:from-purple-900/30 dark:to-purple-800/30',
                  ]}
                >
                  <div
                    class:list={[
                      'absolute left-1/2 top-1/2 h-3 w-3 -translate-x-1/2 -translate-y-1/2 rounded-full',
                      isActive
                        ? 'bg-gradient-to-br from-emerald-400 to-emerald-600'
                        : 'bg-gradient-to-br from-purple-400 to-purple-600',
                    ]}
                  />
                </div>
              </div>

              {/* Content */}
              <div
                class:list={[
                  'min-h-[60px] rounded-xl p-6 transition-all duration-300 hover:translate-x-1',
                  isActive
                    ? 'bg-gradient-to-br from-emerald-50/50 to-transparent dark:from-emerald-950/30'
                    : 'bg-gradient-to-br from-purple-50/50 to-transparent dark:from-purple-950/30',
                ]}
              >
                {/* Header */}
                <div class="flex flex-col gap-1">
                  <h3 class="text-2xl font-bold tracking-tight text-foreground">
                    {item.data.title}
                  </h3>
                  <div>
                    {item.data.organization_url ? (
                      <a
                        href={item.data.organization_url}
                        target="_blank"
                        rel="noopener noreferrer"
                        class:list={[
                          'text-lg font-medium transition-colors hover:underline',
                          isActive
                            ? 'text-emerald-600 hover:text-emerald-700 dark:text-emerald-400 dark:hover:text-emerald-300'
                            : 'text-purple-500 hover:text-purple-600 dark:text-purple-400 dark:hover:text-purple-300',
                        ]}
                      >
                        {item.data.organization}
                      </a>
                    ) : (
                      <span
                        class:list={[
                          'text-lg font-medium',
                          isActive
                            ? 'text-emerald-600 dark:text-emerald-400'
                            : 'text-purple-500 dark:text-purple-400',
                        ]}
                      >
                        {item.data.organization}
                      </span>
                    )}
                  </div>
                  <div class="text-base font-medium text-muted-foreground">
                    {item.data.startDate} {item.data.endDate ? ' - ' + item.data.endDate : ''} â€¢{' '}
                    {item.data.location}
                  </div>
                </div>

                {/* Description */}
                <div class="prose prose-sm dark:prose-invert mt-4 max-w-none">
                  <Content />
                </div>
              </div>
            </div>
          );
        })
      }
    </div>
  </div>
</div>
